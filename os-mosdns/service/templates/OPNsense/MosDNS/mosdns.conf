# MosDNS Configuration Template
# Generated by OPNsense MosDNS Plugin

log:
  level: info
  file: "/var/log/mosdns.log"

api:
  http: "127.0.0.1:8080"

plugins:
{% if helpers.exists('OPNsense.MosDNS.cache') %}
{% for cache in helpers.toList('OPNsense.MosDNS.cache.cache') %}
{% if cache.enabled == '1' %}
  # Cache Plugin: {{ cache.tag }}
  - tag: {{ cache.tag }}
    type: cache
    args:
{% if cache.size %}
      size: {{ cache.size }}
{% endif %}
{% if cache.lazy_cache_ttl %}
      lazy_cache_ttl: {{ cache.lazy_cache_ttl }}
{% endif %}
{% if cache.cache_everything == '1' %}
      cache_everything: true
{% endif %}
{% if cache.lazy_cache_reply_ttl %}
      lazy_cache_reply_ttl: {{ cache.lazy_cache_reply_ttl }}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.forward') %}
{% for forward in helpers.toList('OPNsense.MosDNS.forward.forward') %}
{% if forward.enabled == '1' %}
  # Forward Plugin: {{ forward.tag }}
  - tag: {{ forward.tag }}
    type: forward
    args:
{% if forward.concurrent %}
      concurrent: {{ forward.concurrent }}
{% endif %}
{% if forward.upstreams %}
      upstreams:
{% for upstream in forward.upstreams.split(',') %}
        - addr: {{ upstream.strip() }}
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.redirect') %}
{% for redirect in helpers.toList('OPNsense.MosDNS.redirect.redirect') %}
{% if redirect.enabled == '1' %}
  # Redirect Plugin: {{ redirect.tag }}
  - tag: {{ redirect.tag }}
    type: redirect
    args:
{% if redirect.rules %}
      rules:
{% for rule in redirect.rules.split('\n') %}
{% if rule.strip() %}
        - "{{ rule.strip() }}"
{% endif %}
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.hosts') %}
{% for hosts in helpers.toList('OPNsense.MosDNS.hosts.hosts') %}
{% if hosts.enabled == '1' %}
  # Hosts Plugin: {{ hosts.tag }}
  - tag: {{ hosts.tag }}
    type: hosts
    args:
{% if hosts.files %}
      files:
{% for file in hosts.files.split(',') %}
        - "{{ file.strip() }}"
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.ipset') %}
{% for ipset in helpers.toList('OPNsense.MosDNS.ipset.ipset') %}
{% if ipset.enabled == '1' %}
  # IPSet Plugin: {{ ipset.tag }}
  - tag: {{ ipset.tag }}
    type: ipset
    args:
{% if ipset.files %}
      files:
{% for file in ipset.files.split(',') %}
        - "{{ file.strip() }}"
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.sequence') %}
{% for sequence in helpers.toList('OPNsense.MosDNS.sequence.sequence') %}
{% if sequence.enabled == '1' %}
  # Sequence Plugin: {{ sequence.tag }}
  - tag: {{ sequence.tag }}
    type: sequence
    args:
{% if sequence.steps %}
      exec:
{% for step in sequence.steps %}
{% if step.strip() %}
        - {{ step.strip() }}
{% endif %}
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.fallback') %}
{% for fallback in helpers.toList('OPNsense.MosDNS.fallback.fallback') %}
{% if fallback.enabled == '1' %}
  # Fallback Plugin: {{ fallback.tag }}
  - tag: {{ fallback.tag }}
    type: fallback
    args:
{% if fallback.primary %}
      primary: {{ fallback.primary }}
{% endif %}
{% if fallback.secondary %}
      secondary: {{ fallback.secondary }}
{% endif %}
{% if fallback.threshold %}
      threshold: {{ fallback.threshold }}
{% endif %}
{% if fallback.always_standby == '1' %}
      always_standby: true
{% endif %}

{% endif %}
{% endfor %}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.servers') %}
{% for server in helpers.toList('OPNsense.MosDNS.servers.servers') %}
{% if server.enabled == '1' %}
  # Server Plugin: {{ server.tag }}
  - tag: {{ server.tag }}
    type: {{ server.server_type }}
    args:
{% if server.entry %}
      entry: {{ server.entry }}
{% endif %}
{% if server.listen %}
      listen: {{ server.listen }}
{% endif %}
{% if server.timeout %}
      timeout: {{ server.timeout }}
{% endif %}

{% endif %}
{% endfor %}
{% endif %}