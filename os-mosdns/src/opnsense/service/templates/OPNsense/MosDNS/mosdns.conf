{% if helpers.exists('OPNsense.MosDNS.general.enabled') and OPNsense.MosDNS.general.enabled == '1' %}
# MosDNS Configuration File
# Generated by OPNsense MosDNS Plugin

log:
  level: {{ OPNsense.MosDNS.general.log_level|default('info') }}
  file: /var/log/mosdns.log

plugins:
{% if helpers.exists('OPNsense.MosDNS.upstreams.upstream') %}
{% for upstream in helpers.toList('OPNsense.MosDNS.upstreams.upstream') %}
{% if upstream.enabled == '1' %}
  - tag: forward_{{ upstream.name }}
    type: forward
    args:
      upstreams:
{% if upstream.type == 'https' %}
        - addr: {{ upstream.address }}
{% elif upstream.type == 'tls' %}
        - addr: {{ upstream.address }}
          dial_addr: {{ upstream.address.split('@')[0] if '@' in upstream.address else upstream.address }}:853
{% else %}
        - addr: {{ upstream.address }}
{% endif %}
{% if upstream.timeout %}
      timeout: {{ upstream.timeout }}
{% endif %}
{% endif %}
{% endfor %}
{% else %}
  - tag: forward_default
    type: forward
    args:
      upstreams:
        - addr: 8.8.8.8:53
        - addr: 1.1.1.1:53
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.plugins.plugin') %}
{% for plugin in helpers.toList('OPNsense.MosDNS.plugins.plugin') %}
{% if plugin.enabled == '1' %}
  - tag: {{ plugin.tag }}
    type: {{ plugin.type }}
{% if plugin.args %}
    args:
{{ plugin.args | indent(6, true) }}
{% elif plugin.type == 'udp_server' %}
    args:
      entry: forward_default
      listen: {{ OPNsense.MosDNS.general.listen_address|default('127.0.0.1') }}:{{ OPNsense.MosDNS.general.listen_port|default('53') }}
{% elif plugin.type == 'tcp_server' %}
    args:
      entry: forward_default
      listen: {{ OPNsense.MosDNS.general.listen_address|default('127.0.0.1') }}:{{ OPNsense.MosDNS.general.listen_port|default('53') }}
{% endif %}
{% endif %}
{% endfor %}
{% else %}
  - tag: udp_server
    type: udp_server
    args:
      entry: forward_default
      listen: {{ OPNsense.MosDNS.general.listen_address|default('127.0.0.1') }}:{{ OPNsense.MosDNS.general.listen_port|default('53') }}
  - tag: tcp_server
    type: tcp_server
    args:
      entry: forward_default
      listen: {{ OPNsense.MosDNS.general.listen_address|default('127.0.0.1') }}:{{ OPNsense.MosDNS.general.listen_port|default('53') }}
{% endif %}

{% if helpers.exists('OPNsense.MosDNS.advanced.custom_config') and OPNsense.MosDNS.advanced.custom_config %}
# Custom Configuration
{{ OPNsense.MosDNS.advanced.custom_config }}
{% endif %}
{% endif %}